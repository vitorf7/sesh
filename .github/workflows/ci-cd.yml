# cSpell:words jstemmer benchmem goreleaser
name: Test, Build and Publish

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  tests:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: "1.21"
      - name: Install deps
        run: go install github.com/jstemmer/go-junit-report/v2@latest
      - name: Run tests
        run: go test -cover -bench=. -benchmem -race -v 2>&1 ./... | go-junit-report -set-exit-code > report.xml
      - name: Test Summary
        uses: test-summary/action@v2
        with:
          paths: |
            report.xml
        if: always()

  create-release:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    needs: [tests]
    outputs:
      version: ${{ steps.semanticRelease.outputs.semanticVersion }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install dependencies
        run: npm install -D @semantic-release/exec@6 conventional-changelog-conventionalcommits@6
      - name: Generate release notes and tag
        id: semanticRelease
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: npx semantic-release@22
      - name: Trigger goreleaser workflow
        if: steps.semanticRelease.outputs.semanticVersion
        run: gh workflow run release.yaml --ref v${{ steps.semanticRelease.outputs.semanticVersion }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
